<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿé«˜æ•ˆæ’ç¨‹å™¨ Pro Max</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --study-blue: #E3F2FD;
            --life-orange: #FFF3E0;
            --sport-green: #E8F5E9;
            --border-color: #ddd;
            --pomo-red: #ff5252;
            --google-blue: #4285F4;
        }

        body {
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
            background: #f0f2f5;
            margin: 0;
            padding: 10px;
        }

        /* é ‚éƒ¨å°è¦½ */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            flex-wrap: wrap;
            gap: 10px;
        }

        .btn-group {
            display: flex;
            gap: 8px;
        }

        .btn {
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            transition: 0.3s;
        }

        .export-btn {
            background: var(--google-blue);
        }

        .auth-btn {
            background: #db4437;
        }

        .btn:hover {
            opacity: 0.8;
        }

        /* ç•ªèŒ„é˜æ¢ */
        #pomo-bar {
            display: none;
            background: var(--pomo-red);
            color: white;
            padding: 12px;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-radius: 8px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        /* æ’ç¨‹å™¨ä¸»é«” */
        .scheduler {
            display: grid;
            grid-template-columns: 70px 1fr 1fr 1fr;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .grid-header {
            background: #f8f9fa;
            font-weight: bold;
            text-align: center;
            padding: 12px;
            border-bottom: 2px solid var(--border-color);
            font-size: 0.9rem;
        }

        .cell {
            min-height: 80px;
            border-bottom: 1px solid #eee;
            border-right: 1px solid #eee;
            padding: 8px;
            position: relative;
        }

        .time-label {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            color: #666;
            font-weight: bold;
            background: #fafafa;
        }

        /* å€å¡Šé¡è‰² */
        .study-zone {
            background-color: var(--study-blue);
        }

        .life-zone {
            background-color: var(--life-orange);
        }

        .sport-zone {
            background-color: var(--sport-green);
            transition: 0.3s;
        }

        .completed {
            opacity: 0.3;
            filter: grayscale(0.6);
        }

        textarea {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            resize: none;
            outline: none;
            font-size: 0.9rem;
            padding: 0;
        }

        .pomodoro-btn {
            position: absolute;
            right: 5px;
            bottom: 5px;
            cursor: pointer;
            border: none;
            background: var(--pomo-red);
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* å½ˆçª— */
        #modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            z-index: 1001;
            width: 85%;
            max-width: 400px;
            text-align: center;
        }

        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
        }

        pre#export-preview {
            text-align: left;
            background: #f8f8f8;
            padding: 15px;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.8rem;
            white-space: pre-wrap;
        }

        @media (max-width: 600px) {
            .scheduler {
                grid-template-columns: 60px 1fr 1fr 1fr;
            }

            .grid-header {
                font-size: 0.7rem;
                padding: 8px 4px;
            }

            h1 {
                font-size: 1.1rem;
            }
        }
    </style>
</head>

<body>

    <div id="pomo-bar">
        ğŸ… ç•ªèŒ„å°ˆæ³¨ä¸­ï¼š<span id="timer-display">25:00</span>
        <button onclick="stopPomo()"
            style="margin-left:10px; cursor:pointer; border:none; border-radius:4px; padding:2px 8px;">åœæ­¢</button>
    </div>

    <header>
        <h1 id="current-date">è¼‰å…¥ä¸­...</h1>
        <div class="btn-group">
            <button class="btn export-btn" onclick="prepareExport()">ğŸ“„ åŒ¯å‡º</button>
            <button id="auth-btn" class="btn auth-btn">Google ç™»å…¥</button>
        </div>
    </header>

    <div class="scheduler" id="main-grid">
        <div class="grid-header">æ™‚é–“</div>
        <div class="grid-header" style="color:#1976D2">ğŸ“˜ å­¸ç¿’</div>
        <div class="grid-header" style="color:#E65100">ğŸ  ç”Ÿæ´»</div>
        <div class="grid-header" style="color:#2E7D32">ğŸ’ª é‹å‹•</div>
    </div>

    <div id="overlay" onclick="closeModal()"></div>
    <div id="modal">
        <h3 id="modal-title"></h3>
        <div id="modal-content"></div>
        <br>
        <button class="btn" style="background:#666" onclick="closeModal()">é—œé–‰</button>
    </div>

    <audio id="alarm-sound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";

        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ğŸ”´ è«‹åœ¨æ­¤æ›¿æ›ç‚ºä½ çš„ Firebase Config
        const firebaseConfig = {

            apiKey: "AIzaSyALFKmGkSUGpAo3dx6ecGf0CmZXm9CyHdI",
            authDomain: "student-planner-68a40.firebaseapp.com",
            databaseURL: "https://student-planner-68a40-default-rtdb.firebaseio.com",
            projectId: "student-planner-68a40",
            storageBucket: "student-planner-68a40.firebasestorage.app",
            messagingSenderId: "174462154065",
            appId: "1:174462154065:web:22f7dd25a20435b867cf70",
            measurementId: "G-NBGT1DRDCX"

        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let timerInterval;

        // åˆå§‹åŒ–é é¢
        window.onload = () => {
            const now = new Date();
            document.getElementById('current-date').innerText = now.toLocaleDateString('zh-TW', { month: 'long', day: 'numeric', weekday: 'long' });
            generateGrid();
        };

        function generateGrid() {
            const grid = document.getElementById('main-grid');
            for (let h = 8; h <= 22; h++) {
                grid.innerHTML += `
                <div class="cell time-label">${h}:00</div>
                <div class="cell study-zone"><textarea id="study-${h}" oninput="saveData()"></textarea><button class="pomodoro-btn" onclick="startPomo(${h})">ğŸ…</button></div>
                <div class="cell life-zone"><textarea id="life-${h}" oninput="saveData()"></textarea></div>
                <div class="cell sport-zone" id="sport-cell-${h}"><div style="display:flex;height:100%"><input type="checkbox" id="check-${h}" onchange="toggleSport(${h})"><textarea id="sport-${h}" oninput="saveData()"></textarea></div></div>
            `;
            }
        }

        // ç™»å…¥ç‹€æ…‹ç›£æ§
        onAuthStateChanged(auth, (user) => {
            const authBtn = document.getElementById('auth-btn');
            if (user) {
                currentUser = user;
                authBtn.innerText = `ç™»å‡º (${user.displayName.split(' ')[0]})`;
                authBtn.onclick = () => signOut(auth);
                syncFromCloud();
            } else {
                currentUser = null;
                authBtn.innerText = "Google ç™»å…¥";
                authBtn.onclick = () => signInWithPopup(auth, provider);
                clearGrid();
            }
        });

        // å„²å­˜èˆ‡åŒæ­¥
        window.saveData = function () {
            if (!currentUser) return;
            const data = {};
            for (let h = 8; h <= 22; h++) {
                data[h] = {
                    study: document.getElementById(`study-${h}`).value,
                    life: document.getElementById(`life-${h}`).value,
                    sport: document.getElementById(`sport-${h}`).value,
                    done: document.getElementById(`check-${h}`).checked
                };
            }
            set(ref(db, `users/${currentUser.uid}/planner`), data);
        };

        function syncFromCloud() {
            onValue(ref(db, `users/${currentUser.uid}/planner`), (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    for (let h = 8; h <= 22; h++) {
                        if (data[h]) {
                            document.getElementById(`study-${h}`).value = data[h].study || '';
                            document.getElementById(`life-${h}`).value = data[h].life || '';
                            document.getElementById(`sport-${h}`).value = data[h].sport || '';
                            document.getElementById(`check-${h}`).checked = data[h].done || false;
                            toggleSport(h, false);
                        }
                    }
                }
            });
        }

        // ç•ªèŒ„é˜åŠŸèƒ½
        window.startPomo = function (h) {
            clearInterval(timerInterval);
            document.getElementById('pomo-bar').style.display = 'block';
            let seconds = 25 * 60;
            timerInterval = setInterval(() => {
                seconds--;
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                document.getElementById('timer-display').innerText = `${m}:${s < 10 ? '0' + s : s}`;
                if (seconds <= 0) {
                    clearInterval(timerInterval);
                    document.getElementById('alarm-sound').play();
                    alert("ç•ªèŒ„é˜çµæŸï¼ä¼‘æ¯ä¸€ä¸‹å§ã€‚");
                    stopPomo();
                }
            }, 1000);
        };

        window.stopPomo = function () { clearInterval(timerInterval); document.getElementById('pomo-bar').style.display = 'none'; };

        // é‹å‹•ç‹€æ…‹
        window.toggleSport = function (h, shouldSave = true) {
            const isChecked = document.getElementById(`check-${h}`).checked;
            document.getElementById(`sport-cell-${h}`).classList.toggle('completed', isChecked);
            if (shouldSave) saveData();
        };

        // åŒ¯å‡ºåŠŸèƒ½
        window.prepareExport = function () {
            let text = `ğŸ“… å­¸ç”Ÿæ’ç¨‹å ±å‘Š\n\n`;
            for (let h = 8; h <= 22; h++) {
                const s = document.getElementById(`study-${h}`).value;
                const l = document.getElementById(`life-${h}`).value;
                const sp = document.getElementById(`sport-${h}`).value;
                if (s || l || sp) {
                    text += `${h}:00 >> ${s ? '[å­¸]' + s : ''} ${l ? '[ç”Ÿ]' + l : ''} ${sp ? '[é‹]' + sp : ''}\n`;
                }
            }
            const content = `
            <pre id="export-preview">${text}</pre>
            <button class="btn export-btn" onclick="copyAndGo()">è¤‡è£½ä¸¦é–‹å•Ÿ Google Docs</button>
        `;
            openModal("æº–å‚™åŒ¯å‡º", content);
        };

        window.copyAndGo = function () {
            const text = document.getElementById('export-preview').innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert("å·²è¤‡è£½ï¼è«‹åœ¨ Google Docs æ–°æ–‡ä»¶ä¸­è²¼ä¸Šã€‚");
                window.open('https://docs.google.com/document/u/0/create', '_blank');
            });
        };

        // é€šç”¨ä»‹é¢
        function openModal(title, content) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-content').innerHTML = content;
            document.getElementById('modal').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }
        window.closeModal = function () { document.getElementById('modal').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; };
        function clearGrid() { document.querySelectorAll('textarea').forEach(t => t.value = ''); document.querySelectorAll('input[type="checkbox"]').forEach(c => { c.checked = false; c.dispatchEvent(new Event('change')); }); }
    </script>

</body>

</html>